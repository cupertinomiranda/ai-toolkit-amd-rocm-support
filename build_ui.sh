#!/bin/bash

# --- é…ç½®åŒºåŸŸ ---
TOOLKIT_DIR="$HOME/ai-toolkit"
UI_PORT=8675
# ----------------

echo "========================================"
echo "å‡†å¤‡æ„å»º AI-Toolkit UI (ä¿®æ­£ç‰ˆ)..."
echo "========================================"

# --- 1. æ¸…ç†ç«¯å£ ---
echo "æ­£åœ¨æ£€æŸ¥ç«¯å£ $UI_PORT æ˜¯å¦è¢«å ç”¨..."
PID=$(lsof -t -i:$UI_PORT)
if [ -n "$PID" ]; then
    echo "å‘ç°æ—§è¿›ç¨‹ (PID: $PID) æ­£åœ¨è¿è¡Œï¼Œæ­£åœ¨ç»ˆæ­¢..."
    kill -9 $PID
    echo "âœ… æ—§è¿›ç¨‹å·²æ¸…ç†ã€‚"
else
    echo "âœ… ç«¯å£ç©ºé—²ï¼Œæ— æ—§è¿›ç¨‹ã€‚"
fi

cd "$TOOLKIT_DIR/ui" || { echo "é”™è¯¯: æ‰¾ä¸åˆ° ui ç›®å½•"; read -p "æŒ‰å›è½¦é€€å‡º..."; exit 1; }

# æ£€æŸ¥ npm
if ! command -v npm &> /dev/null; then
    echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° npmã€‚è¯·å…ˆè¿è¡Œ: sudo apt install nodejs npm"
    read -p "æŒ‰å›è½¦é€€å‡º..."
    exit 1
fi

echo "----------------------------------------"
echo "1. å®‰è£…å‰ç«¯ä¾èµ–..."
npm install
echo "----------------------------------------"

# --- ğŸ”¥ å…³é”®ä¿®å¤æ­¥éª¤ ğŸ”¥ ---
echo "2. ç”Ÿæˆ Prisma æ•°æ®åº“å®¢æˆ·ç«¯..."
# è¿™ä¸€æ­¥ä¼šè¯»å– schema.prisma å¹¶ç”Ÿæˆ TypeScript å®šä¹‰ï¼Œè§£å†³ TS2305 æŠ¥é”™
npx prisma generate
# -------------------------

echo "----------------------------------------"
echo "3. å¼€å§‹ç¼–è¯‘æ„å»º..."
npm run build

echo "========================================"
if [ $? -eq 0 ]; then
    echo "ğŸ‰ æ„å»ºæˆåŠŸï¼ç°åœ¨å¯ä»¥è¿è¡Œ start_ui.sh äº†ã€‚"
else
    echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šæ–¹æŠ¥é”™ä¿¡æ¯ã€‚"
fi
echo "========================================"
read -p "æŒ‰å›è½¦é”®å…³é—­çª—å£..."
